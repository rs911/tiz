<script>
	import { onMount } from 'svelte';
	import JSZip from 'jszip';
	let zip = new JSZip();

	let mainText = `
	реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдЕрдореГрддрд╛рдп рдирдордГ
редредреирелренредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╣рд╡рд┐рд╖реЗ рдирдордГ
редредреирелреоредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╡реНрдпреЛрдордореВрд░реНрддреНрддрдпреЗ рдирдордГ
редредреирелрепредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣ рдЕрдореВрд░реНрддрд╛рддреНрдордиреЗ рдирдордГ
редредреиремрежредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдирд┐рд░реНрд▓реЗрдкрд╛рдп рдирдордГ
редредреиремрезредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдирд┐рд░реНрдорд▓рд╛рдп рдирдордГ
редредреиремреиредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдЕрдЪрд▓рд╛рдп рдирдордГ
редредреиремрейредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╕реЛрдордореВрд░реНрддреНрддрдпреЗ рдирдордГ
редредреиремрекредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╕реБрд╕реМрдореНрдпрд╛рддреНрдордиреЗ рдирдордГ
редредреиремрелредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╕реВрд░реНрдпрдореВрд░реНрддреНрддрдпреЗ рдирдордГ
редредреиремремредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдорд╣рд╛рдкреНрд░рднрд╛рдп рдирдордГ
редредреиремренредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдордиреНрддреНрд░рд╡рд┐рджреЗ рдирдордГ
редредреиремреоредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдордиреНрддреНрд░рдХреГрддреЗ рдирдордГ
редредреиремрепредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдордиреНрддреНрд░рд┐рдгреЗ рдирдордГ
редредреиренреж редред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдордиреНрддреНрд░рдореВрд░реНрддреНрддрдпреЗ рдирдордГ
редредреиренрезредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдЕрдирдиреНрддрдЧрд╛рдп рдирдордГ
редредреиренреиредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╕реНрд╡рддрдиреНрддреНрд░рд╛рдп рдирдордГ
редредреиренрейредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рддрдиреНрддреНрд░рдХреГрддреЗ рдирдордГ
редредреиренрекредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╕реНрд╡рдиреНрддрд╛рдп рдирдордГ
редредреиренрелредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдХреГрддрд╛рдиреНрддрд╛рдиреНрддрд╛рдп рдирдордГ
редредреиренремредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдХреГрддрд╛рдиреНрддрдХреГрддреЗ рдирдордГ
редредреиренренредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдХреГрддрд┐рдиреЗ рдирдордГ
редредреиренреоредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдХреГрддрд╛рд░реНрдерд╛рдп рдирдордГ
редредреиренрепредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рд╕рддреНрдХреГрддреНрдпрд╛рдп рдирдордГ
редредреиреорежредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдХреГрддрдХреГрддреНрдпрд╛рдп рдирдордГ
редредреиреорезредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдХреГрддрдХреНрд░рддрд╡реЗ рдирдордГ
редредреиреореиредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдирд┐рддреНрдпрд╛рдп рдирдордГ
редредреиреорейредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдореГрддреНрдпреБрдЮреНрдЬрдпрд╛рдп рдирдордГ
редредреиреорекредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдЕрдореГрддреНрдпрд╡реЗ рдирдордГ
редредреиреорелредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдЕрдореГрддрд╛рддреНрдордиреЗ рдирдордГ
редредреиреоремредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдЕрдореГрддреЛрджреНрднрд╡рд╛рдп рдирдордГ
редредреиреоренредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдмреНрд░рд╣реНрдордирд┐рд╖реНрдард╛рдп рдирдордГ
редредреиреореоредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдкрд░рдВрдмреНрд░рд╣реНрдордгреЗ рдирдордГ
редредреиреорепредред
реР рд╣реНрд░реАрдВ рдЕрд░реНрд╣рдВ рдмреНрд░рд╣реНрдорд╛рддреНрдордиреЗ рдирдордГ
редредреирепреж редред


	`;

	mainText = mainText.trim();
	mainText += '\n'; //To make sure the last text can be split
	mainText = mainText.replace(/рее/g, 'редред');
	let splitTextList = mainText.split(/редред\n/g);
	// console.log(splitTextList[0], splitTextList[2], splitTextList[29]);
	for (let i = 0; i < splitTextList.length; i++) {
		splitTextList[i] = splitTextList[i].replace(/[\r\n\x0B\x0C\u0085\u2028\u2029]+/g, ' ') + 'редред';
	}
	// This fixes the last
	splitTextList.pop();
	console.log(splitTextList.length + ' files');

	let canvasList = [];
	onMount(() => {
		for (let i = 0; i < canvasList.length; i++) {
			t2i(canvasList[i], splitTextList[i]);

			canvasList[i].toBlob(
				(blob) => {
					// If zip functionality is not needed, direct image download can be done using
					// the following code and removing all the code for dlBtn element.

					// const anchor = document.createElement('a');
					// anchor.download = 'image' + i + '.jpg'; // optional, but you can give the file a name
					// anchor.href = URL.createObjectURL(blob);
					// anchor.click(); //Magic
					// URL.revokeObjectURL(anchor.href); // remove it from memory and save on memory! ЁЯШО
					let fileName = 'image' + (i + 1) + '.jpg'; // optional, but you can give the file a name
					zip.file(fileName, blob);
				},
				'image/jpeg',
				0.9
			);
		}
		// comment the following to removing zip functionality.
		let dlBtn = document.getElementById('dlBtn');
		dlBtn.addEventListener('click', download);
	});
	async function download() {
		const content = await zip.generateAsync({ type: 'blob' });
		const anchor = document.createElement('a');
		anchor.download = 'images.zip';
		anchor.href = URL.createObjectURL(content);
		anchor.click(); //Auto click the link
		URL.revokeObjectURL(anchor.href); // remove it from memory and save on memory!
	}

	function t2i(textCanvas, text) {
		let ctx = textCanvas.getContext('2d');
		ctx.reset();
		ctx.textBaseline = 'middle';
		ctx.textAlign = 'center';
		ctx.font = '40px Arial';
		ctx.fillStyle = 'rgb(0,0,0)';
		ctx.fillRect(0, 0, 650, 200);
		ctx.fillStyle = 'rgb(255,255,255)';
		ctx.fillText(text, textCanvas.width / 2, textCanvas.height / 2);
	}
</script>

<h3>Canvas</h3>
<div>
	<button id="dlBtn">Download ZIP</button>
</div>
{#each splitTextList as tl, i}
	<canvas height="200" width="650" bind:this={canvasList[i]} />
{/each}
